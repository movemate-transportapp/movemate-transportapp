<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Transportasi Gamifikasi - User App (Progress 5)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #F3F4F6; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .clean-card { background: #FFFFFF; border: 1px solid #E5E7EB; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border-radius: 16px; overflow: hidden; }
    .clean-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
    .clean-btn:active { transform: scale(0.96); }
    .spinner { border: 3px solid rgba(37, 99, 235, 0.3); border-radius: 50%; border-top: 3px solid #2563EB; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes pop-up { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    .animate-pop { animation: pop-up 0.2s ease-out forwards; }
    .status-pulse { animation: pulse-green 2s infinite; }
    @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
  </style>
  <script>
    tailwind.config = {
      theme: { extend: { colors: { brand: { black: '#111827', gray: '#6B7280', blue: '#2563EB', green: '#059669', red: '#DC2626', orange: '#EA580C' } } } }
    }
  </script>
</head>

<body class="text-gray-900">
  <div id="app"></div>

  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- SUPABASE CONFIG ---
    const SUPABASE_URL = 'https://swdfpihhjwdxfxfdpwbu.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3ZGZwaWhoandkeGZ4ZmRwd2J1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NTY1MTEsImV4cCI6MjA4MTQzMjUxMX0.4odsbEqYM4CA46V8HcZyRT8MIe_TWRlLbmpO9XJtGEE'; 
    const dbClient = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;

    // --- ICONS ---
    const Icons = {
        Zap: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
        QrCode: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="5" height="5" x="3" y="3" rx="1"/><rect width="5" height="5" x="16" y="3" rx="1"/><rect width="5" height="5" x="3" y="16" rx="1"/><path d="M21 16h-3a2 2 0 0 0-2 2v3"/><path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/><path d="M3 12h.01"/><path d="M12 3h.01"/><path d="M12 16v.01"/><path d="M16 12h1"/><path d="M21 12v.01"/><path d="M12 21v-1"/></svg>,
        Bus: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 6v6"/><path d="M15 6v6"/><path d="M2 12h19.6"/><path d="M18 18h3s.5-1.7.8-2.8c.1-.4.2-.8.2-1.2 0-.4-.1-.8-.2-1.2l-1.4-5C20.1 6.8 19.1 6 18 6H4a2 2 0 0 0-2 2v10h3"/><circle cx="7" cy="18" r="2"/><path d="M9 18h5"/><circle cx="16" cy="18" r="2"/></svg>,
        Home: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
        X: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>,
        Clock: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    };

    // --- QR RENDERER ---
    function QRCodeRenderer({ text }) {
        const qrRef = useRef(null);
        useEffect(() => {
            if (qrRef.current) {
                qrRef.current.innerHTML = "";
                new QRCode(qrRef.current, { text: text, width: 220, height: 220, colorDark : "#111827", colorLight : "#ffffff" });
            }
        }, [text]);
        return <div ref={qrRef} className="p-4 bg-white rounded-2xl border border-gray-100 inline-block shadow-sm" />;
    }

    // --- AUTH SCREEN (Simplified) ---
    function AuthScreen({ onLoginSuccess }) {
        const [email, setEmail] = useState("");
        const [loading, setLoading] = useState(false);
        const handleLogin = async (e) => {
            e.preventDefault();
            setLoading(true);
            try {
                const { data, error } = await dbClient.auth.signInWithPassword({ email, password: "password123" }); // Hardcoded for demo ease
                if (error) throw error;
                onLoginSuccess(data.session);
            } catch (err) {
                // Fallback Mock Login
                onLoginSuccess({ user: { id: 'mock-123', email: email } });
            } finally { setLoading(false); }
        };
        return (
            <div className="h-screen flex flex-col items-center justify-center p-6 bg-white">
                <div className="w-full max-w-sm clean-card p-8 border-t-4 border-t-brand-blue">
                    <h2 className="text-2xl font-bold mb-2">Masuk</h2>
                    <p className="text-sm text-gray-500 mb-6">Demo: Gunakan email bebas, password apa saja.</p>
                    <form onSubmit={handleLogin} className="space-y-4">
                        <input type="email" required value={email} onChange={e=>setEmail(e.target.value)} className="w-full p-3 border rounded-lg" placeholder="Email" />
                        <button type="submit" disabled={loading} className="w-full bg-brand-blue text-white py-3 rounded-xl font-bold">{loading ? "..." : "Masuk"}</button>
                    </form>
                </div>
            </div>
        );
    }

    // --- MAIN APP ---
    function App() {
        const [session, setSession] = useState(null);
        const [userData, setUserData] = useState(null);
        const [activeTrip, setActiveTrip] = useState(null);
        const [qrData, setQrData] = useState(null);
        const [qrTimer, setQrTimer] = useState(0);
        const [currentPage, setCurrentPage] = useState("home");
        const [tripFinishedData, setTripFinishedData] = useState(null);

        // 1. Initial Load
        useEffect(() => {
            if (session?.user?.id && session.user.id !== 'mock-123') {
                fetchUserData();
                // REALTIME SUBSCRIPTION
                const channel = dbClient.channel('custom-all-channel')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'trips', filter: `user_id=eq.${session.user.id}` }, (payload) => {
                    console.log('Change received!', payload);
                    fetchUserData(); // Reload data when Trip changes
                })
                .subscribe();

                return () => { dbClient.removeChannel(channel); };
            } else if (session?.user?.id === 'mock-123') {
                setUserData({ name: "Demo User", points: 1000 });
            }
        }, [session]);

        const fetchUserData = async () => {
            const uid = session.user.id;
            // Get Profile
            const { data: profile } = await dbClient.from('profiles').select('*').eq('id', uid).single();
            if (profile) setUserData(profile);
            
            // Get Active Trip
            const { data: trip } = await dbClient.from('trips').select('*').eq('user_id', uid).eq('status', 'active').maybeSingle();
            
            // Logic Deteksi Perubahan Status (Untuk Auto Close QR)
            if (trip) {
                // User baru saja  In (Trip Active)
                setActiveTrip(trip);
                if (currentPage === 'qr') {
                     // Tutup QR, balik ke Home
                    setQrData(null);
                    setCurrentPage("home");
                }
            } else {
                // Tidak ada trip aktif
                // Cek apakah barusan ada trip selesai?
                if (activeTrip && !trip) {
                    // Berarti baru saja Tap Out -> Tampilkan Summary
                    const { data: lastTrip } = await dbClient.from('trips').select('*').eq('user_id', uid).eq('status', 'completed').order('end_time', {ascending: false}).limit(1).single();
                    if (lastTrip) {
                        setTripFinishedData(lastTrip);
                        setCurrentPage("trip_summary");
                    }
                }
                setActiveTrip(null);
            }
        };

        // 2. Timer Countdown Logic (30 Detik)
        useEffect(() => {
            let interval = null;
            if (currentPage === 'qr' && qrTimer > 0) {
                interval = setInterval(() => {
                    setQrTimer((prev) => prev - 1);
                }, 1000);
            } else if (qrTimer === 0 && currentPage === 'qr') {
                // Waktu Habis
                setQrData(null);
                setCurrentPage("home");
                alert("Kode QR Kedaluwarsa. Silakan generate ulang.");
            }
            return () => clearInterval(interval);
        }, [qrTimer, currentPage]);

        // 3. Generate QR Logic (Tap In vs Tap Out)
        const generateQR = (type) => {
            if (!userData || session.user.id === 'mock-123') {
                alert("Fitur ini butuh akun asli (bukan mock).");
                return;
            }

            const payload = {
                uid: session.user.id,
                name: userData.name,
                type: type, // "TAP_IN" or "TAP_OUT"
                timestamp: Date.now() // Security: Unique Timestamp
            };

            setQrData({
                type: type,
                code: JSON.stringify(payload),
                title: type === "TAP_IN" ? "Tap In (Naik)" : "Tap Out (Turun)"
            });
            setQrTimer(30); // Set 30 Detik
            setCurrentPage("qr");
        };

        if (!session) return <AuthScreen onLoginSuccess={setSession} />;

        return (
            <div className="max-w-md mx-auto h-screen bg-gray-50 flex flex-col relative overflow-hidden shadow-2xl">
                
                {/* --- PAGE: HOME --- */}
                {currentPage === 'home' && (
                    <div className="flex-1 overflow-y-auto p-6">
                        {/* Header */}
                        <div className="flex justify-between items-center mb-8 pt-4">
                            <div>
                                <h1 className="text-2xl font-bold text-gray-900">Halo, {userData?.name || 'User'}</h1>
                                <p className="text-xs text-gray-500">Saldo Poin: <span className="font-bold text-brand-blue">{userData?.points || 0}</span></p>
                            </div>
                            <div className="w-10 h-10 bg-brand-blue rounded-full flex items-center justify-center text-white font-bold">
                                {userData?.name?.charAt(0) || 'U'}
                            </div>
                        </div>

                        {/* STATUS CARD: IDLE vs IN JOURNEY */}
                        {!activeTrip ? (
                            // --- STATE: IDLE ---
                            <div className="clean-card p-6 bg-white relative overflow-hidden">
                                <div className="relative z-10">
                                    <span className="bg-gray-100 text-gray-600 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider">Status: Idle</span>
                                    <h3 className="text-xl font-bold text-gray-900 mt-2 mb-1">Siap Berangkat?</h3>
                                    <p className="text-sm text-gray-500 mb-6">Scan QR di Halte untuk mulai perjalanan.</p>
                                    
                                    <button onClick={() => generateQR("TAP_IN")} className="w-full bg-brand-blue text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-200 active:scale-95 transition-transform">
                                        <Icons.QrCode className="w-5 h-5" />
                                        Buat QR Tap In
                                    </button>
                                </div>
                                {/* Decor */}
                                <div className="absolute -right-6 -bottom-6 text-gray-50 opacity-50"><Icons.Bus width={150} height={150} /></div>
                            </div>
                        ) : (
                            // --- STATE: IN JOURNEY ---
                            <div className="clean-card p-6 bg-gray-900 text-white relative overflow-hidden border-none shadow-xl">
                                <div className="flex items-center gap-2 mb-4">
                                    <div className="w-3 h-3 bg-green-500 rounded-full status-pulse"></div>
                                    <span className="text-xs font-bold text-green-400 uppercase tracking-widest">Sedang Dalam Perjalanan</span>
                                </div>
                                
                                <div className="flex gap-4 items-center mb-6">
                                    <div className="p-3 bg-white/10 rounded-xl backdrop-blur-sm">
                                        <Icons.Bus className="w-8 h-8 text-blue-300" />
                                    </div>
                                    <div>
                                        <p className="text-gray-400 text-xs uppercase">Naik Dari</p>
                                        <h2 className="text-xl font-bold text-white">{activeTrip.start_station}</h2>
                                        <p className="text-xs text-gray-500 font-mono mt-1">{activeTrip.start_time}</p>
                                    </div>
                                </div>

                                <button onClick={() => generateQR("TAP_OUT")} className="w-full bg-red-600 hover:bg-red-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-red-900/50 active:scale-95 transition-transform border border-red-500">
                                    <Icons.QrCode className="w-5 h-5" />
                                    Tap Out (Turun)
                                </button>
                            </div>
                        )}

                        <div className="mt-6">
                            <h3 className="font-bold text-gray-900 mb-2">Riwayat Singkat</h3>
                            <div className="clean-card p-4 text-center text-sm text-gray-400">Belum ada riwayat lain.</div>
                        </div>
                    </div>
                )}

                {/* --- PAGE: QR DISPLAY --- */}
                {currentPage === 'qr' && (
                    <div className="absolute inset-0 bg-white z-50 flex flex-col animate-pop">
                        <div className="p-4 flex justify-between items-center border-b">
                            <button onClick={() => { setQrData(null); setCurrentPage("home"); }} className="p-2 bg-gray-100 rounded-full">
                                <Icons.X className="w-6 h-6 text-gray-600" />
                            </button>
                            <span className="font-bold">{qrData?.title}</span>
                            <div className="w-10"></div>
                        </div>
                        <div className="flex-1 flex flex-col items-center justify-center p-6 text-center">
                            <div className={`mb-6 px-4 py-2 rounded-full font-mono font-bold flex items-center gap-2 ${qrTimer < 10 ? 'bg-red-100 text-red-600' : 'bg-blue-50 text-brand-blue'}`}>
                                <Icons.Clock className="w-4 h-4" />
                                <span>00:{qrTimer.toString().padStart(2, '0')}</span>
                            </div>
                            
                            <QRCodeRenderer text={qrData?.code || ""} />
                            
                            <p className="mt-8 text-gray-500 text-sm max-w-[250px]">
                                Arahkan kode ini ke Scanner Petugas Halte. <br/>
                                <span className="text-xs text-gray-400 mt-2 block">Kode akan kedaluwarsa dalam 30 detik.</span>
                            </p>
                        </div>
                    </div>
                )}

                {/* --- PAGE: TRIP SUMMARY --- */}
                {currentPage === 'trip_summary' && tripFinishedData && (
                    <div className="absolute inset-0 bg-white z-50 flex flex-col items-center justify-center p-8 animate-pop text-center">
                        <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6">
                            <Icons.Zap className="w-12 h-12 text-green-600 fill-current" />
                        </div>
                        <h2 className="text-2xl font-bold text-gray-900">Perjalanan Selesai!</h2>
                        <p className="text-gray-500 text-sm mt-2">Terima kasih telah menggunakan transportasi umum.</p>
                        
                        <div className="w-full clean-card bg-gray-50 p-6 mt-8 mb-8 text-left">
                            <div className="flex justify-between mb-4 border-b pb-4">
                                <div>
                                    <p className="text-xs text-gray-400 uppercase">Dari</p>
                                    <p className="font-bold text-gray-800">{tripFinishedData.start_station}</p>
                                </div>
                                <div className="text-right">
                                    <p className="text-xs text-gray-400 uppercase">Ke</p>
                                    <p className="font-bold text-gray-800">{tripFinishedData.end_station}</p>
                                </div>
                            </div>
                            <div className="flex justify-between items-center">
                                <span className="font-bold text-gray-900">Poin Didapat</span>
                                <span className="text-xl font-bold text-brand-blue">+{tripFinishedData.points_earned} Poin</span>
                            </div>
                        </div>

                        <button onClick={() => { setTripFinishedData(null); setCurrentPage("home"); }} className="w-full bg-brand-black text-white py-4 rounded-xl font-bold shadow-lg">
                            Kembali ke Beranda
                        </button>
                    </div>
                )}
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById("app"));
    root.render(<App />);
  </script>
</body>
</html>
